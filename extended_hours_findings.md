# 키움 REST API 시간외 거래 조사 결과

**조사 일시**: 2025-12-03 16:11  
**조사자**: AI Agent  
**테스트 종목**: 005930 (삼성전자)  
**시장 세션**: 시간외 단일가 (16:00-18:00)

---

## executive Summary

키움 REST API의 `ka10001` (주식현재가시세) API는 **시간외 거래를 구분하는 파라미터나 응답 필드가 없습니다**. 현재 구현으로는 장중 가격과 시간외 거래 가격을 명시적으로 구분할 수 없습니다.

---

## 주요 발견사항

### 1. ka10001 API 분석 결과

#### 요청 형식
```json
{
  "stk_cd": "005930"
}
```

#### 문제점
- ❌ **장구분 파라미터 없음**: 시간외 거래를 요청할 수 있는 파라미터 없음
- ❌ **장구분 응답 필드 없음**: 현재 데이터가 어느 세션인지 알 수 없음
- ❌ **시간외 전용 데이터 없음**: 시간외 가격을 별도로 조회할 방법 없음

#### 테스트 시 응답 데이터 (16:11, 시간외 단일가 시간대)

```json
{
  "name": "삼성전자",
  "code": "005930",
  "price": "+104500",
  "change": "+1100",
  "rate": "+1.06%"
}
```

**분석**:
- 시간외 거래 시간대(16:11)에 조회했지만, 응답에 장구분 정보가 없음
- 반환된 가격이 **장중 종가**인지 **시간외 최신 거래가**인지 불명확
- API 설계상 가장 최근 체결가를 반환하는 것으로 추정

### 2. 원본 API 응답 전체 분석

#### 발견된 필드 목록
```
stk_cd, stk_nm, setl_mm, cur_prc, pred_pre, flu_rt, 
per, pbr, roe, mac, bus_pro, sale_amt, 
[호가 관련], [투자자별 관련], return_code, return_msg
```

#### 장구분 관련 필드 검색 결과
- 검색 키워드: `market`, `session`, `mrkt`, `trde`, `jang`, `장`
- **결과**: ❌ **장구분 관련 필드 없음**

> [!IMPORTANT]
> ka10001 API는 현재가 조회 전용이며, 실시간 데이터나 시간외 구분 없이 가장 최근 체결가만 반환합니다.

### 3. 대체 API 테스트 결과

| API ID | 설명 | 테스트 결과 | 비고 |
|--------|------|-------------|------|
| ka10001 | 주식현재가시세 | ✓ 성공 | 현재 사용 중 |
| ka10087 | 시간외단일가 (추정) | ✗ 실패 | API 존재하지 않거나 다른 엔드포인트 필요 |
| ka10002 | 호가 조회 | ✓ 성공 | 매수/매도 호가 데이터 제공 |
| ka10003 | 체결 조회 | ✓ 성공 | 체결 내역 제공 |

#### ka10002 (호가 조회) 응답 예시
```
응답 키: ['sel_trde_qty_1', 'buy_trde_ori_1', ..., 'return_code', 'return_msg']
```
- 매수/매도 호가 정보 포함
- 하지만 **시간외 호가와 장중 호가를 구분하는 필드는 없음**

#### ka10003 (체결 조회) 응답 예시
```
응답 키: ['cntr_infr', 'return_code', 'return_msg']
```
- 체결 정보 제공
- 역시 **장구분 필드 없음**

---

## 시간외 거래 데이터 반영 현황

### 현재 동작 방식 (추정)

1. **정규 장중 (09:00-15:30)**
   - ka10001은 실시간 체결가를 반환
   - ✓ 정상 작동

2. **장개시전 시간외 (08:30-08:40)**
   - 당일 종가로 거래되므로, 전일 종가가 표시될 가능성
   - ⚠️ **시간외 거래 중인지 알 수 없음**

3. **장종료후 종가매매 (15:40-16:00)**
   - 당일 종가로 거래
   - API는 종가를 반환할 것으로 예상
   - ⚠️ **장후 시간외인지 구분 불가**

4. **시간외 단일가 (16:00-18:00)**
   - 10분 단위로 단일가 체결
   - **테스트 시점 (16:11)**: 가격 104,500원 반환
   - ⚠️ **이 가격이 시간외 체결가인지 종가인지 불명확**

### 문제점 정리

1. **사용자가 보는 가격의 출처를 알 수 없음**
   - 장중 가격인지, 시간외 가격인지 구분 불가
   - 시간외 거래 활성 여부 알 수 없음

2. **시간외 가격 변동 추적 불가**
   - 시간외 단일가 매매 시 10분마다 가격 변동
   - 현재 API로는 이 변동을 감지할 방법 없음

3. **투자 판단 정보 부족**
   - 시간외 거래량, 시간외 호가 등 확인 불가
   - 장개시전 수급 상황 파악 어려움

---

## 원인 분석

### 키움 REST API의 설계 한계

키움 REST API는 **폴링(Polling) 방식의 HTTP 기반 API**입니다:

1. **실시간 데이터 미제공**
   - REST는 요청/응답 모델이므로 실시간 스트리밍 불가
   - 시간외 거래의 실시간 체결가 추적 어려움

2. **장구분 파라미터 부재**
   - OpenAPI+ (OCX)에는 실시간 데이터의 '장구분' FID가 존재 (1:장전, 2:장중, 3:장후)
   - REST API에는 이러한 구분 메커니즘이 없음

3. **시간외 전용 API 부재**
   - OpenAPI+의 `opt10087` (시간외 단일가) 같은 TR은 REST API에 대응되지 않음
   - ka10087 테스트 결과 실패 → REST API에 없는 것으로 판단

---

## 해결 방안

### Option 1: 시간 기반 로직 구현 (현실적 대안)

현재 시간을 기준으로 시장 세션을 판단하고 UI에 표시:

```python
def get_market_session():
    now = datetime.datetime.now()
    current_time = now.time()
    
    if time(8, 30) <= current_time <= time(8, 40):
        return "장개시전 시간외"
    elif time(15, 40) <= current_time <= time(16, 0):
        return "장종료후 종가매매"
    elif time(16, 0) <= current_time <= time(18, 0):
        return "시간외 단일가"
    elif time(9, 0) <= current_time <= time(15, 30):
        return "장중"
    else:
        return "거래시간 외"
```

**장점**:
- 현재 API 그대로 사용 가능
- 사용자에게 현재 세션 정보 제공

**단점**:
- 실제 시간외 거래 발생 여부와 무관하게 시간만으로 판단
- 공휴일, 시장 휴장일 등 예외 처리 필요

### Option 2: 키움 REST API 문서 재확인

**프로젝트 내 `키움 REST API 문서.xlsx` 파일 분석**:
1. 시간외 전용 API ID 존재 여부 확인
2. ka10001의 응답 필드 상세 명세 확인
3. WebSocket 실시간 API 제공 여부 확인

### Option 3: 키움 OpenAPI+ 사용 검토

**장점**:
- 실시간 데이터 제공 (장구분 포함)
- 시간외 호가/체결 정보 제공
- `opt10087` 등 시간외 전용 TR 사용 가능

**단점**:
- Windows 전용 (ActiveX/OCX)
- 현재 프로젝트가 REST API 기반이므로 아키텍처 변경 필요
- 두 가지 API를 병행 사용해야 할 수 있음

### Option 4: 키움 WebSocket API 조사

일부 증권사는 REST API와 별도로 WebSocket 기반 실시간 API 제공:
- 실시간 시세 스트리밍
- 장구분 정보 포함 가능성
- 키움증권이 제공하는지 문서 확인 필요

---

## 권장 사항

### 단기 (즉시 적용 가능)

1. **시간 기반 세션 표시 추가**
   ```python
   # stock_analysis_service.py에 추가
   session_info = get_market_session()
   # UI에 "현재: 시간외 단일가" 표시
   ```

2. **사용자 안내 메시지**
   - 시간외 거래 시간대에 "현재 시간외 거래 중입니다" 표시
   - "표시된 가격은 최근 체결가이며, 시간외 거래가 반영될 수 있습니다" 주의사항 표시

### 중기 (추가 조사 필요)

1. **키움 REST API 문서 정밀 분석**
   - Excel 파일에서 시간외 관련 API 검색
   - 개발자 포털에서 공식 문서 확인

2. **다른 API ID 전수 조사**
   - ka 시리즈 API 목록 확인
   - 각 API의 파라미터와 응답 필드 분석

3. **WebSocket API 조사**
   - 키움증권 실시간 데이터 API 제공 여부
   - 제공된다면 연동 방법 파악

### 장기 (아키텍처 변경)

1. **OpenAPI+ 병행 사용**
   - 시세 조회는 REST API
   - 실시간 시간외 데이터는 OpenAPI+
   - 하이브리드 아키텍처 검토

2. **타 증권사 API 검토**
   - 한국투자증권, NH투자증권 등의 REST API
   - 시간외 거래 데이터 제공 여부 비교

---

## 다음 단계

### 즉시 실행 가능

- [x] 테스트 코드 작성 및 실행
- [x] API 응답 데이터 분석
- [ ] Excel 문서에서 시간외 관련 API 확인
- [ ] 시간 기반 세션 표시 기능 구현 (선택)

### 추가 조사 필요

- [ ] 키움 개발자 포털에서 공식 문서 확인
- [ ] WebSocket API 제공 여부 확인
- [ ] 실제 시간외 거래 시간대(08:30-08:40, 15:40-18:00)에 재테스트
- [ ] HTS에서 표시되는 시간외 가격과 API 응답 비교

### 사용자 결정 필요

1. **현재 REST API로 만족할 수 있는가?**
   - 시간 기반 로직으로 충분하다면 → Option 1 선택
   - 정확한 시간외 데이터가 필요하다면 → Option 3 또는 4 검토

2. **구현 범위**
   - 단순 안내 메시지만 추가
   - 시간외 거래 전용 UI 개발
   - OpenAPI+ 통합

---

## 테스트 로그

### 실행 환경
- **일시**: 2025-12-03 16:11:56
- **시장 상태**: 시간외 단일가 (16:00-18:00)
- **테스트 종목**: 005930 (삼성전자)

### 테스트 결과
```
ka10001 API: ✓ 성공 (가격: 104,500원, 등락: +1.06%)
ka10002 API: ✓ 성공 (호가 데이터 제공)
ka10003 API: ✓ 성공 (체결 데이터 제공)
ka10087 API: ✗ 실패 (존재하지 않음)

장구분 필드: ✗ 발견되지 않음
시간외 구분: ✗ 불가능
```

### 결론
키움 REST API는 현재 **시간외 거래를 명시적으로 구분할 수 없는 구조**입니다.
