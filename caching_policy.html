<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œìŠ¤í…œ ìºì‹± ì •ì±… ë° ë°ì´í„° íë¦„</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --accent-color: #3b82f6;
            --border-color: #404040;
            --code-bg: #111;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        h1,
        h2,
        h3 {
            color: #fff;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 1.5em;
        }

        h1 {
            margin-top: 0;
            font-size: 2em;
            border-bottom: 2px solid var(--accent-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--bg-color);
            border-radius: 8px;
            overflow: hidden;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #333;
            color: var(--accent-color);
            font-weight: 600;
        }

        code {
            background-color: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .mermaid {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .badge-client {
            background: #10b981;
            color: #fff;
        }

        .badge-server-mem {
            background: #f59e0b;
            color: #fff;
        }

        .badge-server-file {
            background: #6366f1;
            color: #fff;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            th,
            td {
                padding: 8px 10px;
                font-size: 0.9em;
            }

            h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ì‹œìŠ¤í…œ ìºì‹± ì •ì±… ë° ë°ì´í„° íë¦„ ë¶„ì„</h1>
        <p>ì´ ë¬¸ì„œëŠ” ì£¼ì‹ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ ìµœì í™”ì™€ API ë¹„ìš© ì ˆê°ì„ ìœ„í•´ êµ¬í˜„ëœ <strong>ì´ì¤‘ ìºì‹± ì•„í‚¤í…ì²˜(Dual Caching Architecture)</strong>ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.
        </p>

        <h2>1. ìºì‹± ì •ì±… ê°œìš” (Caching Policy)</h2>
        <p>ì‹œìŠ¤í…œì€ <strong>í´ë¼ì´ì–¸íŠ¸(ë¸Œë¼ìš°ì €)</strong>ì™€ <strong>ì„œë²„(Backend)</strong> ì–‘ìª½ì—ì„œ ìºì‹±ì„ ìˆ˜í–‰í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ê³¼ ê³ ë¹„ìš©ì˜ AI API í˜¸ì¶œì„
            ìµœì†Œí™”í•©ë‹ˆë‹¤.</p>

        <table>
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>ìœ„ì¹˜</th>
                    <th>ì €ì¥ ë§¤ì²´</th>
                    <th>ë§Œë£Œ ì‹œê°„ (TTL)</th>
                    <th>ì£¼ìš” ì—­í• </th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="badge badge-client">í´ë¼ì´ì–¸íŠ¸ ìºì‹œ</span></td>
                    <td>ì‚¬ìš©ì ë¸Œë¼ìš°ì €</td>
                    <td>ë©”ëª¨ë¦¬ (JS ê°ì²´ <code>sentimentCache</code>)</td>
                    <td><strong>30ë¶„</strong></td>
                    <td>í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€, ì„œë²„ ë¶€í•˜ ê°ì†Œ, ì¦‰ê°ì ì¸ UI ì‘ë‹µ</td>
                </tr>
                <tr>
                    <td><span class="badge badge-server-mem">ì„œë²„ ë©”ëª¨ë¦¬ ìºì‹œ</span></td>
                    <td>Flask ì„œë²„</td>
                    <td>RAM (<code>_memory_cache</code>)</td>
                    <td><strong>10ë¶„</strong></td>
                    <td><strong>ì´ˆê³ ì† ì‘ë‹µ (Hot Data)</strong>, ìì£¼ ì¡°íšŒë˜ëŠ” ì¢…ëª©ì˜ ë¹ ë¥¸ ë°˜í™˜</td>
                </tr>
                <tr>
                    <td><span class="badge badge-server-file">ì„œë²„ íŒŒì¼ ìºì‹œ</span></td>
                    <td>ì„œë²„ ë””ìŠ¤í¬</td>
                    <td>JSON íŒŒì¼ (<code>cache/</code>)</td>
                    <td><strong>60ë¶„</strong></td>
                    <td><strong>API ë¹„ìš© ì ˆê° (Long-tail)</strong>, ë°ì´í„° ì˜ì†ì„± ë° ì‚¬ìš©ì ê°„ ê³µìœ </td>
                </tr>
            </tbody>
        </table>

        <h2>2. ë°ì´í„° íë¦„ë„ (Data Flow Architecture)</h2>
        <p>ì‚¬ìš©ìê°€ íŠ¹ì • ì¢…ëª©(ì˜ˆ: ì‚¼ì„±ì „ì)ì˜ ë¶„ì„ ì •ë³´ë¥¼ ìš”ì²­í•  ë•Œì˜ ë°ì´í„° ì²˜ë¦¬ íë¦„ì…ë‹ˆë‹¤.</p>

        <div class="mermaid">
            sequenceDiagram
            participant User as ğŸ‘¤ ì‚¬ìš©ì (ë¸Œë¼ìš°ì €)
            participant ClientCache as ğŸ“¦ í´ë¼ì´ì–¸íŠ¸ ìºì‹œ (JS)
            participant Server as ğŸ–¥ï¸ ì„œë²„ (Flask)
            participant ServerCache as ğŸ—„ï¸ ì„œë²„ ìºì‹œ (File/Mem)
            participant Gemini as ğŸ§  Google Gemini API

            Note over User, ClientCache: 1. ë°ì´í„° ìš”ì²­
            User->>ClientCache: ì¢…ëª© ë¶„ì„ ìš”ì²­ (ì‚¼ì„±ì „ì)

            alt í´ë¼ì´ì–¸íŠ¸ ìºì‹œ ìœ íš¨ (Hit)
            ClientCache-->>User: âš¡ ì¦‰ì‹œ ë°˜í™˜ (0ms)
            else í´ë¼ì´ì–¸íŠ¸ ìºì‹œ ì—†ìŒ (Miss)
            ClientCache->>Server: 2. API ìš”ì²­ (/api/analyze)

            Server->>ServerCache: 3. ì„œë²„ ìºì‹œ í™•ì¸

            alt ì„œë²„ ìºì‹œ ìœ íš¨ (Hit)
            ServerCache-->>Server: ğŸ“‚ íŒŒì¼/ë©”ëª¨ë¦¬ ë°ì´í„° ë°˜í™˜
            else ì„œë²„ ìºì‹œ ì—†ìŒ (Miss)
            Server->>Gemini: 4. AI ë¶„ì„ ìš”ì²­ (ğŸ’° ë¹„ìš© ë°œìƒ)
            Gemini-->>Server: 5. ë¶„ì„ ê²°ê³¼ ì‘ë‹µ
            Server->>ServerCache: 6. ê²°ê³¼ ì €ì¥ (ê³µìœ  ìºì‹œ ìƒì„±)
            end

            Server-->>ClientCache: 7. ì‘ë‹µ ì „ì†¡
            ClientCache-->>User: 8. í™”ë©´ í‘œì‹œ & ìºì‹œ ì €ì¥
            end
        </div>

        <h2>3. ìƒì„¸ êµ¬í˜„ ë¡œì§</h2>

        <h3>A. í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìºì‹± (<code>static/js/main.js</code>, <code>ui.js</code>)</h3>
        <ul>
            <li><strong>ì €ì¥ì†Œ</strong>: <code>window.sentimentCache</code> (ë©”ëª¨ë¦¬ ê°ì²´)</li>
            <li><strong>ë™ì‘ ì›ë¦¬</strong>:
                <ol>
                    <li><strong>ìë™ ê°±ì‹  (ë¦¬ë³¸/ë°°ì§€)</strong>: <code>updateSingleSentiment</code> í•¨ìˆ˜ê°€ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë  ë•Œ, ìºì‹œì— ë°ì´í„°ê°€ ìˆê³ 
                        30ë¶„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ë‹¤ë©´ API í˜¸ì¶œì„ ê±´ë„ˆë›°ê³  ìºì‹œëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
                    <li><strong>ìˆ˜ë™ í´ë¦­ (ìƒì„¸ ëª¨ë‹¬)</strong>: ì‚¬ìš©ìê°€ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ <code>openStockModal</code> í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
                        <ul>
                            <li>ì´ë•Œ <code>loadFullAnalysis(code, false)</code>ë¥¼ í˜¸ì¶œí•˜ì—¬ <strong>ê°•ì œ ê°±ì‹ ì„ í•˜ì§€ ì•Šê³ </strong> ì„œë²„ ìºì‹œë¥¼
                                ìš°ì„  í™•ì¸í•©ë‹ˆë‹¤.</li>
                            <li><strong>ì¤‘ë³µ ìš”ì²­ ë°©ì§€</strong>: ì´ë¯¸ í•´ë‹¹ ì¢…ëª©ì— ëŒ€í•œ ë¶„ì„ ìš”ì²­ì´ ì§„í–‰ ì¤‘ì´ë¼ë©´(<code>_pendingRequests</code>),
                                ìƒˆë¡œìš´ ìš”ì²­ì„ ë³´ë‚´ì§€ ì•Šê³  ê¸°ì¡´ ìš”ì²­ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li><strong>ë°ì´í„° ë™ê¸°í™”</strong>: ìƒì„¸ ë¶„ì„ì´ ì™„ë£Œë˜ë©´ <code>updateSentimentFromAnalysis</code>ê°€ í˜¸ì¶œë˜ì–´ ìµœì‹  ë¶„ì„ ê²°ê³¼ë¥¼
                        <code>sentimentCache</code>ì—ë„ ì¦‰ì‹œ ë°˜ì˜í•©ë‹ˆë‹¤. ë•ë¶„ì— ëª¨ë‹¬ì„ ë‹«ì•„ë„ ë¦¬ìŠ¤íŠ¸ì˜ ì •ë³´ê°€ ìµœì‹  ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.</li>
                </ol>
            </li>
            <li><strong>íš¨ê³¼</strong>: ì‚¬ìš©ìê°€ ì¹´ë“œë¥¼ ë°˜ë³µí•´ì„œ í´ë¦­í•˜ê±°ë‚˜ íƒ­ì„ ë¹ ë¥´ê²Œ ì´ë™í•´ë„ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•Šì•„ ì¾Œì í•œ UXë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
        </ul>

        <h3>B. ì„œë²„ ì¸¡ ìºì‹± (<code>gemini_service.py</code>)</h3>
        <ul>
            <li><strong>ê³„ì¸µì  êµ¬ì¡°</strong>: <code>ë©”ëª¨ë¦¬ ìºì‹œ</code> â†’ <code>íŒŒì¼ ìºì‹œ</code> ìˆœì„œë¡œ í™•ì¸í•˜ëŠ” <strong>L1/L2 ìºì‹œ êµ¬ì¡°</strong>ë¥¼
                ê°€ì§‘ë‹ˆë‹¤.</li>
            <li><strong>íŒŒì¼ ìºì‹œ (L2)</strong>:
                <ul>
                    <li>ê²½ë¡œ: <code>cache/{ì¢…ëª©ì½”ë“œ}_{íƒ€ì…}_{ë‚ ì§œ}.json</code></li>
                    <li><strong>Atomic Write</strong>: ë°ì´í„° ì†ìƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì„ì‹œ íŒŒì¼ ì‘ì„± í›„ ì´ë¦„ ë³€ê²½(<code>rename</code>)
                        ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
                    </li>
                    <li><strong>ê³µìœ  ìºì‹œ íš¨ê³¼</strong>: <strong>ì‚¬ìš©ì A</strong>ê°€ ë¶„ì„í•œ ê²°ê³¼ë¥¼ ì„œë²„ íŒŒì¼ë¡œ ì €ì¥í•´ë‘ë©´, <strong>ì‚¬ìš©ì
                            B</strong>ê°€
                        ë™ì¼ ì¢…ëª© ì¡°íšŒ ì‹œ API í˜¸ì¶œ ì—†ì´ ì €ì¥ëœ íŒŒì¼ì„ ê·¸ëŒ€ë¡œ ë°˜í™˜ë°›ìŠµë‹ˆë‹¤.</li>
                </ul>
            </li>
        </ul>

        <h2>4. ì‹œìŠ¤í…œ ì´ì  (Benefits)</h2>
        <ul>
            <li><strong>ë¹„ìš© ì ˆê° (Cost Efficiency)</strong>: ìºì‹±ì„ í†µí•´ ë™ì¼ ì¢…ëª©ì— ëŒ€í•œ ì¤‘ë³µ í˜¸ì¶œì„ 90% ì´ìƒ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </li>
            <li><strong>ì†ë„ í–¥ìƒ (Performance)</strong>: AI ë¶„ì„ì€ í†µìƒ 3~5ì´ˆê°€ ì†Œìš”ë˜ì§€ë§Œ, ìºì‹œëœ ë°ì´í„°ëŠ” <strong>0.01ì´ˆ
                    ì´ë‚´</strong>ì— ë°˜í™˜ë©ë‹ˆë‹¤.
            </li>
            <li><strong>ë°ì´í„° ì¼ê´€ì„± (Consistency)</strong>: ì§§ì€ ì‹œê°„ ë‚´ì— ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì¡°íšŒí•˜ë”ë¼ë„ ë™ì¼í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•˜ì—¬ ì •ë³´ì˜ í˜¼ì„ ì„
                ë°©ì§€í•©ë‹ˆë‹¤.</li>
        </ul>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#e0e0e0',
                edgeLabelBackground: '#fff',
                tertiaryColor: '#fff'
            }
        });
    </script>
</body>

</html>